{% extends "base.html" %}

{% block title %}系统设置 - PVC报价系统{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">系统设置</h2>
    
    <div id="noPermission" class="hidden p-4 bg-red-50 border border-red-200 rounded-md text-red-700">
        您没有权限访问此页面，仅管理员可修改设置。
    </div>
    
    <form id="settingsForm" onsubmit="handleSaveSettings(event)" class="space-y-6">
        <!-- 利润与损耗 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">利润与损耗</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">利润率</label>
                    <input type="number" name="profit_margin" step="0.01" min="0" max="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">废品率</label>
                    <input type="number" name="waste_rate" step="0.01" min="0" max="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 材料参数 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">材料参数</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">材料密度 (g/cm³)</label>
                    <input type="number" name="material_density" step="0.001" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">材料单价 (元/g)</label>
                    <input type="number" name="material_price_per_gram" step="0.001" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 产能参数 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">产能参数</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具边长 (cm)</label>
                    <input type="number" name="mold_edge_length" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">产品间距 (cm)</label>
                    <input type="number" name="mold_spacing" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">基准产模数/班</label>
                    <input type="number" name="base_molds_per_shift" step="1" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">每月工作天数</label>
                    <input type="number" name="working_days_per_month" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">每日班次数</label>
                    <input type="number" name="shifts_per_day" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">机台针头数</label>
                    <input type="number" name="needles_per_machine" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 调机与调色费用 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">调机与调色费用</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">单色调机费 (元)</label>
                    <input type="number" name="setup_fee_per_color" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">基础调机费 (元)</label>
                    <input type="number" name="base_setup_fee" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">单色单班调色费 (元)</label>
                    <input type="number" name="coloring_fee_per_color_per_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 生产单元成本 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">生产单元成本 (元/班)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">其他工资</label>
                    <input type="number" name="other_salary_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">房租</label>
                    <input type="number" name="rent_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">电费</label>
                    <input type="number" name="electricity_fee_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 工人配置 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">工人配置</h3>
            <div id="workerProfiles" class="space-y-3"></div>
        </div>
        
        <div class="flex justify-end space-x-4">
            <button type="button" onclick="loadSettings()" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                重置
            </button>
            <button type="submit" id="saveButton" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center">
                <span id="saveButtonText">保存设置</span>
                <div id="saveSpinner" class="spinner ml-2 hidden"></div>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let settingsData = null;
    
    // 加载设置
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            
            if (response.status === 403 || response.status === 401) {
                document.getElementById('noPermission').classList.remove('hidden');
                document.getElementById('settingsForm').classList.add('hidden');
                return;
            }
            
            if (response.ok) {
                settingsData = await response.json();
                populateForm(settingsData);
            }
        } catch (error) {
            console.error('加载设置失败:', error);
            showToast('加载设置失败', 'error');
        }
    }
    
    // 填充表单
    function populateForm(data) {
        const form = document.getElementById('settingsForm');
        const settings = data.settings;
        
        // 填充应用设置
        for (const [key, value] of Object.entries(settings)) {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && value !== null) {
                input.value = value;
            }
        }
        
        // 填充工人配置
        const workerDiv = document.getElementById('workerProfiles');
        workerDiv.innerHTML = data.worker_profiles.map(wp => `
            <div class="grid grid-cols-3 gap-4 p-3 bg-gray-50 rounded">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">类型</label>
                    <input type="text" value="${wp.name}" readonly class="w-full px-3 py-2 border rounded-md bg-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">月薪 (元)</label>
                    <input type="number" data-worker="${wp.name}" data-field="monthly_salary" value="${wp.monthly_salary}" 
                        step="100" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">操作机器数</label>
                    <input type="number" data-worker="${wp.name}" data-field="machines_operated" value="${wp.machines_operated}" 
                        min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        `).join('');
    }
    
    // 保存设置
    async function handleSaveSettings(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const saveButton = document.getElementById('saveButton');
        const saveButtonText = document.getElementById('saveButtonText');
        const saveSpinner = document.getElementById('saveSpinner');
        
        saveButton.disabled = true;
        saveButtonText.textContent = '保存中...';
        saveSpinner.classList.remove('hidden');
        
        // 构建更新数据
        const updateData = {
            settings: {},
            worker_profiles: []
        };
        
        // 收集应用设置
        for (const [key, value] of formData.entries()) {
            if (value) {
                const numValue = parseFloat(value);
                updateData.settings[key] = isNaN(numValue) ? value : numValue;
            }
        }
        
        // 收集工人配置
        const workerInputs = document.querySelectorAll('[data-worker]');
        const workerMap = {};
        workerInputs.forEach(input => {
            const name = input.dataset.worker;
            const field = input.dataset.field;
            if (!workerMap[name]) {
                workerMap[name] = { name };
            }
            workerMap[name][field] = field === 'machines_operated' ? parseInt(input.value) : parseFloat(input.value);
        });
        updateData.worker_profiles = Object.values(workerMap);
        
        try {
            const response = await fetch('/api/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                showToast('设置已保存');
                await loadSettings();
            } else {
                const error = await response.json();
                showToast(error.detail || '保存失败', 'error');
            }
        } catch (error) {
            console.error('保存设置失败:', error);
            showToast('保存设置失败', 'error');
        } finally {
            saveButton.disabled = false;
            saveButtonText.textContent = '保存设置';
            saveSpinner.classList.add('hidden');
        }
    }
    
    // 页面加载时
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCurrentUser();
        
        // 检查管理员权限
        if (!currentUser || !currentUser.is_admin) {
            document.getElementById('noPermission').classList.remove('hidden');
            document.getElementById('settingsForm').classList.add('hidden');
        } else {
            loadSettings();
        }
    });
</script>
{% endblock %}


