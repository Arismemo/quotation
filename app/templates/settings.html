{% extends "base.html" %}

{% block title %}系统设置 - PVC报价系统{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">系统设置</h2>
    
    <div id="noPermission" class="hidden p-4 bg-red-50 border border-red-200 rounded-md text-red-700">
        您没有权限访问此页面，仅管理员可修改设置。
    </div>
    
    <form id="settingsForm" onsubmit="handleSaveSettings(event)" class="space-y-6">
        <!-- 利润与损耗 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">利润与损耗</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">利润率</label>
                    <input type="number" name="profit_margin" step="0.01" min="0" max="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">废品率</label>
                    <input type="number" name="waste_rate" step="0.01" min="0" max="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 材料参数 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">材料参数</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">材料密度 (g/cm³)</label>
                    <input type="number" name="material_density" step="0.001" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">材料单价 (元/g)</label>
                    <input type="number" name="material_price_per_gram" step="0.001" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 产能参数 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">产能参数</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模具边长 (cm)</label>
                    <input type="number" name="mold_edge_length" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">产品间距 (cm)</label>
                    <input type="number" name="mold_spacing" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">基准产模数/班</label>
                    <input type="number" name="base_molds_per_shift" step="1" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">每月工作天数</label>
                    <input type="number" name="working_days_per_month" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">每日班次数</label>
                    <input type="number" name="shifts_per_day" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">机台针头数</label>
                    <input type="number" name="needles_per_machine" min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 调机与调色费用 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">调机与调色费用</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">单色调机费 (元)</label>
                    <input type="number" name="setup_fee_per_color" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">基础调机费 (元)</label>
                    <input type="number" name="base_setup_fee" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">单色单班调色费 (元)</label>
                    <input type="number" name="coloring_fee_per_color_per_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 生产单元成本 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">生产单元成本 (元/班)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">其他工资</label>
                    <input type="number" name="other_salary_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">房租</label>
                    <input type="number" name="rent_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">电费</label>
                    <input type="number" name="electricity_fee_per_cell_shift" step="0.1" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        </div>
        
        <!-- 图像识别算法（仅前端本地保存） -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">图像识别算法</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">默认识别算法</label>
                    <select id="cfgAnalysisMethod" class="w-full px-3 py-2 border rounded-md">
                        <option value="rembg">rembg（抠图）</option>
                        <option value="opencv">OpenCV（阈值/轮廓）</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">此配置将保存在浏览器本地，用作识别默认算法。</p>
                </div>
            </div>
        </div>

        <!-- 工人配置 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">工人配置</h3>
            <div id="workerProfiles" class="space-y-3"></div>
        </div>
        
        <!-- 颜色数量 -> 单班产模数 映射 -->
        <div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">颜色数量-单班产模数映射</h3>
            <p class="text-xs text-gray-500 mb-2">用于替代“难度系数”，根据颜色数量范围确定单班产模数。</p>
            <div id="colorOutputList" class="space-y-2"></div>
            <button type="button" onclick="addColorOutputRow()" class="mt-2 px-3 py-1.5 border rounded-md text-sm hover:bg-gray-50">添加映射区间</button>
        </div>
        
        <div class="flex justify-end space-x-4">
            <button type="button" onclick="loadSettings()" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                重置
            </button>
            <button type="submit" id="saveButton" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center">
                <span id="saveButtonText">保存设置</span>
                <div id="saveSpinner" class="spinner ml-2 hidden"></div>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let settingsData = null;
    
    // 加载设置
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            
            if (response.status === 403 || response.status === 401) {
                document.getElementById('noPermission').classList.remove('hidden');
                document.getElementById('settingsForm').classList.add('hidden');
                return;
            }
            
            if (response.ok) {
                settingsData = await response.json();
                populateForm(settingsData);
            }
        } catch (error) {
            console.error('加载设置失败:', error);
            showToast('加载设置失败', 'error');
        }
    }
    
    // 填充表单
    function populateForm(data) {
        const form = document.getElementById('settingsForm');
        const settings = data.settings;
        
        // 填充应用设置
        for (const [key, value] of Object.entries(settings)) {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && value !== null) {
                input.value = value;
            }
        }
        
        // 填充工人配置
        const workerDiv = document.getElementById('workerProfiles');
        workerDiv.innerHTML = data.worker_profiles.map(wp => `
            <div class="grid grid-cols-3 gap-4 p-3 bg-gray-50 rounded">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">类型</label>
                    <input type="text" value="${wp.name}" readonly class="w-full px-3 py-2 border rounded-md bg-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">月薪 (元)</label>
                    <input type="number" data-worker="${wp.name}" data-field="monthly_salary" value="${wp.monthly_salary}" 
                        step="100" min="0" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">操作机器数</label>
                    <input type="number" data-worker="${wp.name}" data-field="machines_operated" value="${wp.machines_operated}" 
                        min="1" class="w-full px-3 py-2 border rounded-md">
                </div>
            </div>
        `).join('');

        // 填充颜色映射
        const colorDiv = document.getElementById('colorOutputList');
        const list = Array.isArray(settings.color_output_map) ? settings.color_output_map : [];
        colorDiv.innerHTML = list.map((item, idx) => renderColorOutputRow(idx, item)).join('');

        // 填充本地算法设置
        const localMethod = localStorage.getItem('analysisMethod') || 'rembg';
        const sel = document.getElementById('cfgAnalysisMethod');
        if (sel) sel.value = localMethod;
    }
    
    // 保存设置
    async function handleSaveSettings(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const saveButton = document.getElementById('saveButton');
        const saveButtonText = document.getElementById('saveButtonText');
        const saveSpinner = document.getElementById('saveSpinner');
        
        saveButton.disabled = true;
        saveButtonText.textContent = '保存中...';
        saveSpinner.classList.remove('hidden');
        
        // 构建更新数据
        const updateData = {
            settings: {},
            worker_profiles: []
        };
        
        // 收集应用设置
        for (const [key, value] of formData.entries()) {
            if (value) {
                const numValue = parseFloat(value);
                updateData.settings[key] = isNaN(numValue) ? value : numValue;
            }
        }
        // 收集颜色映射
        updateData.settings.color_output_map = collectColorOutputMap();
        
        // 收集工人配置
        const workerInputs = document.querySelectorAll('[data-worker]');
        const workerMap = {};
        workerInputs.forEach(input => {
            const name = input.dataset.worker;
            const field = input.dataset.field;
            if (!workerMap[name]) {
                workerMap[name] = { name };
            }
            workerMap[name][field] = field === 'machines_operated' ? parseInt(input.value) : parseFloat(input.value);
        });
        updateData.worker_profiles = Object.values(workerMap);
        
        try {
            const response = await fetch('/api/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                // 保存本地算法设置
                const sel = document.getElementById('cfgAnalysisMethod');
                if (sel && sel.value) {
                    localStorage.setItem('analysisMethod', sel.value);
                }
                showToast('设置已保存');
                await loadSettings();
            } else {
                const error = await response.json();
                showToast(error.detail || '保存失败', 'error');
            }
        } catch (error) {
            console.error('保存设置失败:', error);
            showToast('保存设置失败', 'error');
        } finally {
            saveButton.disabled = false;
            saveButtonText.textContent = '保存设置';
            saveSpinner.classList.add('hidden');
        }
    }

    // 渲染单条颜色映射行
    function renderColorOutputRow(idx, item={}){
        const minVal = item.min_colors ?? '';
        const maxVal = item.max_colors ?? '';
        const molds = item.molds_per_shift ?? '';
        return `
            <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-3">
                    <label class="block text-xs text-gray-600">最少颜色</label>
                    <input type="number" min="0" class="w-full px-2 py-1 border rounded" data-color-row="${idx}" data-field="min_colors" value="${minVal}">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs text-gray-600">最多颜色</label>
                    <input type="number" min="0" class="w-full px-2 py-1 border rounded" data-color-row="${idx}" data-field="max_colors" value="${maxVal}">
                </div>
                <div class="col-span-4">
                    <label class="block text-xs text-gray-600">单班产模数</label>
                    <input type="number" min="0" class="w-full px-2 py-1 border rounded" data-color-row="${idx}" data-field="molds_per_shift" value="${molds}">
                </div>
                <div class="col-span-2 flex items-end">
                    <button type="button" class="px-2 py-1 border rounded text-sm" onclick="removeColorOutputRow(${idx})">删除</button>
                </div>
            </div>
        `;
    }

    function addColorOutputRow(){
        const colorDiv = document.getElementById('colorOutputList');
        const idx = colorDiv.children.length;
        colorDiv.insertAdjacentHTML('beforeend', renderColorOutputRow(idx, {}));
    }

    function removeColorOutputRow(idx){
        const colorDiv = document.getElementById('colorOutputList');
        const rows = Array.from(colorDiv.children);
        if (rows[idx]) rows[idx].remove();
        // 重新编号 data-color-row
        Array.from(colorDiv.querySelectorAll('[data-color-row]')).forEach((el, i)=>{
            el.setAttribute('data-color-row', i);
        });
    }

    function collectColorOutputMap(){
        const colorDiv = document.getElementById('colorOutputList');
        const rows = Array.from(colorDiv.children);
        const list = [];
        rows.forEach(row => {
            const idx = row.querySelector('[data-color-row]')?.getAttribute('data-color-row');
            const getVal = (field)=>{
                const el = row.querySelector(`[data-field="${field}"]`);
                return el && el.value !== '' ? parseFloat(el.value) : null;
            };
            const min_colors = getVal('min_colors');
            const max_colors = getVal('max_colors');
            const molds_per_shift = getVal('molds_per_shift');
            if (min_colors !== null && max_colors !== null && molds_per_shift !== null){
                list.push({ min_colors, max_colors, molds_per_shift });
            }
        });
        return list;
    }
    
    // 页面加载时
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCurrentUser();
        
        // 检查管理员权限
        if (!currentUser || !currentUser.is_admin) {
            document.getElementById('noPermission').classList.remove('hidden');
            document.getElementById('settingsForm').classList.add('hidden');
        } else {
            loadSettings();
        }
    });
</script>
{% endblock %}


